{{template "_header.html" .}}
{{template "_nav_main.html" .}}

{{$repoOwner := .RepoOwner}}
{{$repoName := .RepoName}}
{{$state := .ERepo.MustRepoState}}


<main id="repo-detail" class="constrain-page">

    <section class="repo-detail-section">

        <div class="header-bar">
            <h1><a class="repo-title" href="/">{{.Repo.Name}}</a></h1>
        </div>

        {{if .Repo.Description}}
        <p>{{.Repo.Description}}</p>
        {{end}}

        <div class="detail-container">

            <ul class="repo-detail-controls">
                <li>
                    <a href="https://github.com/{{.RepoOwner}}/{{.Repo.Name}}/settings/collaboration" target="github">
                        Add or remove collaborators
                    </a>
                </li>
                <li>
                    <a href="/repo/{{.RepoOwner}}/{{.Repo.Name}}/diff">
                        View project history
                    </a>
                </li>
                <li>
                    <a href="/repo/{{.RepoOwner}}/{{.Repo.Name}}/files">
                        Manage image files
                    </a>
                </li>
                <li>
                    <a href="/repo/{{.RepoOwner}}/{{.RepoName}}/detail" target="_blank">
                        See project on GitHub
                    </a>
                </li>
            </ul>

            {{if $state.LocalConflicted}}
                <p>Your project is in a conflicted state because a merge didn't complete. <a class="btn" href="/repo/{{.RepoOwner}}/{{.RepoName}}/conflict">Complete the merge</a></p>
            {{else}}
                {{if $state.LocalInSync}}
                    <p>Your project is ready for editing. <a class="btn" href="/repo/{{.RepoOwner}}/{{.RepoName}}/">Edit</a></p>


                    {{if $state.ParentNotExist}}
                        <p>You are managing the original project. There is no parent project to contribute to.</p>
                    {{else}}
                        {{if .UpstreamActions.CanPull}}
                        <p>Your copy of this project is behind the project you are contributing to. <a class="btn" href="/repo/{{.RepoOwner}}/{{.RepoName}}/merge/upstream/master">Update my copy from its parent</a>
                        </p>
                        {{end}}
                        {{if .UpstreamActions.CanCreatePR}}
                        <p>You've made changes you have not shared with the project you are contributing to. <a href="/repo/{{.RepoOwner}}/{{.Repo.Name}}/pull/new" class="btn">Submit these changes for review</a></p>
                        {{end}}
                        {{if .UpstreamActions.InSync}}
                        <p>Your copy and the project you are contributing to are in sync. Good work.</p>
                        {{end}}
                    {{end}}

                    {{if .PullRequests}}
                        <p>You have {{.PullRequests | len}} submission{{if gt (len .PullRequests) 1}}s{{end}} to review.</p>
                    {{end}}


                {{else}}
                    {{if $state.LocalChangesStaged}}
                    <p>You have made changes that you can commit. <a href="/repo/{{.RepoOwner}}/{{.RepoName}}/commit" class="btn">Commit your changes</a></p>
                    {{else}}

                        {{if $state.LocalChangesUnstaged}}
                        <!--WE WILL AUTOMATICALLY REVERT THESE-->
                        <p>We've found some files in your project that you don't need. Don't worry. These were probably created by an incomplete output-generation process.</p>
                        {{end}}

                        {{if $state.LocalBehind}}
                            <p>Your version on GitHub has changed. You need to fetch these changes. 
                            <div data-instance="RepoMergeButton" data-repo-merge="origin/master">Fetch changes</div></p>
                        {{else}}
                            {{if $state.LocalAhead}}
                                <p>There are changes you have committed that have not been sent to GitHub. If this problem persists, please contact support.<a class="btn" href="/repo/{{.RepoOwner}}/{{.RepoName}}/push/origin/master">Update GitHub version</a></p>
                            {{end}}
                        {{end}}
                    {{end}}
                {{end}}

            {{end}}

            {{if $state.LocalUnimplemented}}
                <p>Your project is in a state that we can't handle. Sorry. Please contact support.</p>
            {{end}}            
        </div>
    </section>

{{if not $state.LocalConflicted}}

    {{if .PullRequests}}
    <section class="repo-detail-section">

        <div class="title-links">
            <h3 id="review">Submissions to review</h3>
        </div>

        {{if $state.LocalChanges}}
            <div class="pull-requests-warning">
                <p>You cannot review submissions until you have committed your own changes.</p>
            </div>
        {{end}}

        <ul class="pull-requests">
        {{range .PullRequests}}
            <li class="pull-request-item">
                <div class="pull-request-item-title">
                    <a {{if $state.LocalChanges}}disabled="disabled"{{else}}href="pull/{{.GetNumber}}"{{end}}>{{.GetTitle}}</a>
                </div>
                <div class="pull-request-item-user">
                    {{if .User}}
                        <img src="{{.User.AvatarURL}}" alt="{{.User.GetLogin}}" class="pull-request-item-user-avatar"> {{.User.GetLogin}}
                    {{end}}
                </div>
                <div class="pull-request-item-date">
                        {{.GetCreatedAt | humantime}}
                </div>
                <a class="btn pull-request-item-review" {{if $state.LocalChanges}}disabled="disabled"{{else}}href="pull/{{.GetNumber}}"{{end}}>Review submission</a>
            </li>
        {{end}}
        </ul>        

    </section>
    {{end}}


    {{if .StagedFiles}}
    <section class="repo-detail-section">

        <div class="title-links">
            <h3>Changes to commit</h3>

            <div class="action-group">
                <a href="/repo/{{.RepoOwner}}/{{.Repo.Name}}/commit" class="btn">Commit these changes</a>
                {{if $state.LocalChanges -}}
                <a href="#" class="btn" id="cancelAllChanges">Discard these changes</a>
                {{- end}}
            </div>

        </div>

        <ol type="1">
        {{range .StagedFiles}}
            <li class="staged-{{.StatusString}}">
                {{.Path}}
            </li>
        {{end}}
        </ol>

    </section>
    {{end}}
{{end}}
</main>

<script type="text/hidden" id="ebw-context" data-repo-owner="{{.RepoOwner}}" data-repo-name="{{.RepoName}}" data-page="RepoDetailPage">
</script>

{{template "_nav_footer.html" .}}
{{template "_footer.html" .}}
